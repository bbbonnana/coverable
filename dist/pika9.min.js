"use strict";function t(t){return"object"==typeof t&&void 0!==t.nodeType}function e(t,n,i=!1){if(i){const i=["","-webkit-","-ms-","moz-","-o-"];for(let o=0;o<i.length;o++){const s=e(t,i[o]+n);if(s)return s}return""}let o="";return t.currentStyle?o=t.currentStyle[n]:document.defaultView&&document.defaultView.getComputedStyle&&(o=document.defaultView.getComputedStyle(t,null).getPropertyValue(n)),o&&o.toLowerCase?o.toLowerCase():o}function n(t,e){if(!e||function(t,e){return new RegExp("(^|\\s)"+e+"($|\\s)").test(t.className)}(t,e))return;const n=""===t.className?" ":t.className;" "===n.charAt(n.length-1)?t.className+=e:t.className+=" "+e}function i(t,e){if(!e)return"";const n=t.className.split(/\s+/);let i=n.indexOf(e);return i>-1?(n.splice(i,1),t.className=n.join(" "),e):""}
/*!
 * merge-descriptors
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var o=function(t,e,n){if(!t)throw new TypeError("argument dest is required");if(!e)throw new TypeError("argument src is required");void 0===n&&(n=!0);return Object.getOwnPropertyNames(e).forEach((function(i){if(n||!s.call(t,i)){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o)}})),t},s=Object.prototype.hasOwnProperty;const l=()=>{};function r(t,n){this._init(),this.target=t,this._onClick=n.onClick||l,this._onHoldStart=n.onHoldStart||l,this._onHoldMove=n.onHoldMove||l,this._onHoldEnd=n.onHoldEnd||l;let i=null;this._touchStartHandler=t=>{if(this._isDown||!this._enable)return;const n=this.target.getBoundingClientRect();let o=e(this.target,"border-width");o=o?Number(o.split("px")[0]):0,i=(t,e)=>{const i=t+this.target.scrollLeft-n.left-o,s=e+this.target.scrollTop-n.top-o;return{x:t,y:e,contentX:i,contentY:s,offsetX:t-i,offsetY:e-s}};const s=i(t.clientX,t.clientY);this._startPoint=s,this._activePoint=null,function(t,e){const{x:n,y:i}=e;return n<=0||i<=0||n>=t.clientWidth+t.scrollLeft||i>=t.clientHeight+t.scrollTop}(this.target,{x:s.contentX,y:s.contentY})||(this._prepareEmitStart=()=>{this._onHoldStart.call(null,{startPoint:s,target:this.target})},this._isDown=!0)},this._touchMoveHandler=t=>{if(!this._isDown||!this._enable)return;this._isHold||(this._isHold=!0,this._prepareEmitStart(),this._prepareEmitStart=null);const e=i(t.clientX,t.clientY);this._activePoint=e,this._onHoldMove.call(null,{startPoint:this._startPoint,activePoint:e,target:this.target})},this._touchEndHandler=t=>{if(this._isDown&&this._enable){if(this._isDown=!1,this._isHold){this._isHold=!1;const e=i(t.clientX,t.clientY);this._activePoint=e,this._onHoldEnd.call(null,{startPoint:this._startPoint,activePoint:e,target:this.target})}else this._onClick.call(null,{activePoint:this._startPoint,target:this.target});this._prepareEmitStart=null,i=null}},this._onPageMouseUp=t=>{this.enable&&this._isHold&&this._touchEndHandler({})}}r.prototype.enable=function(){this._check(),this._loadEvents(),this._enable=!0},r.prototype.disable=function(){this._check(),this._enable=!1},r.prototype.unload=function(){this._check(),this._unloadEvents(),this._init(),this._unload=!0},r.prototype._init=function(){this.target=null,this._listening=!1,this._enable=!1,this._isDown=!1,this._isHold=!1,this._startPoint=null,this._activePoint=null,this._unload=!1,this._onClick=null,this._onHoldStart=null,this._onHoldMove=null,this._onHoldEnd=null},r.prototype._check=function(){if(this._unload)throw new Error("Holder has been unloaded!")},r.prototype._loadEvents=function(){this._listening||(this._listening=!0,this.target.addEventListener("mousedown",this._touchStartHandler),this.target.addEventListener("mousemove",this._touchMoveHandler),this.target.addEventListener("mouseup",this._touchEndHandler),document.addEventListener("mouseup",this._onPageMouseUp))},r.prototype._unloadEvents=function(){this._listening&&(this.target.removeEventListener("mousedown",this._touchStartHandler),this.target.removeEventListener("mousemove",this._touchMoveHandler),this.target.removeEventListener("mouseup",this._touchEndHandler),document.removeEventListener("mouseup",this._onPageMouseUp),this._listening=!1)};function c(t){this.el=null,this._parent=t,this._staticStyle="";let e=void 0;Object.defineProperty(this,"_visible",{enumerable:!1,configurable:!1,get:()=>e,set(t){(t=!!t)!==e&&this.el&&(this.el.style.cssText=t?this._staticStyle:"display: none;"),e=t}})}c.prototype.unmount=function(){this.el&&this.el.remove(),i(this._parent,"pika9-selection-parent"),i(this._parent,"pika9-selection-parent--relative")},c.prototype.mount=function(){const t=this._parent;if(!this.el){const e=document.createElement("div");e.className="pika9-selection",this.el=e,this._visible=!1,n(t,"pika9-selection-parent")}t.appendChild(this.el)},c.prototype.show=function(){const t=this._parent,i=e(t,"position");-1===["fixed","absolute","relative"].indexOf(i)&&n(t,"pika9-selection-parent--relative"),this._visible=!0},c.prototype.hide=function(){this._visible=!1},c.prototype.update=function(t,e,n,i){if(!this.el||!this._visible)return;const o=["position: absolute",`top: ${e}px`,`left: ${t}px`],s=[];n<0&&(s.push(`translateX(${n}px)`),n=-n),i<0&&(s.push(`translateY(${i}px)`),i=-i),o.push(`width: ${n}px`),o.push(`height: ${i}px`),s.length&&o.push("transform: "+s.join(" "));const l=o.join("; ");this._staticStyle=l,this.el.style.cssText=l};const a={parent:null,elements:[]};function h(t,e,n){const i=(t=o({...a},t||{})).origin;delete t.origin,this._options=Object.freeze(t),this.init(i,e,n)}h.prototype.start=function(t){const{contentX:e,contentY:n,offsetX:i,offsetY:o}=t.startPoint;this.init({x:e,y:n},i,o),this.addElements(this._options.elements)},h.prototype.hold=function(t){const e=t.activePoint;return this.getElementsRelative({x:e.contentX,y:e.contentY})},h.prototype.end=function(t){const e=t.activePoint;return this.getElementsRelative({x:e.contentX,y:e.contentY})},h.prototype.init=function(t,e,n){this._origin=t||{x:0,y:0},this._offsetX=e||0,this._offsetY=n||0,this._quadrants=[0,0,0,0].map((()=>({items:[],sortType:"",x:{total:0,dispersion:0},y:{total:0,dispersion:0}})))},h.prototype.add=function(t){const e=function(t){if(!t.length)return null;const e=t.reduce(((t,e)=>(t.x+=e.x,t.y+=e.y,t)),{x:0,y:0});return e.x/=t.length,e.y/=t.length,e}(function(t,e=0,n=0){const i=t.getBoundingClientRect(),o=i.left+e,s=i.top+n;return[{x:o,y:s},{x:o+i.width,y:s},{x:o+i.width,y:s+i.height},{x:o,y:s+i.height}]}(t,-this._offsetX,-this._offsetY)),n={avgOriginPoint:this._getCSYSPoint(e),absOriginPoint:null,element:t};n.absOriginPoint={x:Math.abs(n.avgOriginPoint.x),y:Math.abs(n.avgOriginPoint.y)};const i=this._getQuadrant(n.avgOriginPoint);i.items.push(n),i.sortType="",i.x.total+=n.avgOriginPoint.x,i.y.total+=n.avgOriginPoint.y},h.prototype.addElements=function(t){if(void 0!==t.length){let e=-1;for(;++e<t.length;)this.add(t[e])}else this.add(t)},h.prototype._getCSYSPoint=function(t){return{x:t.x-this._origin.x,y:t.y-this._origin.y}},h.prototype._getQuadrant=function(t){return t.x>=0?t.y>0?this._quadrants[0]:this._quadrants[3]:t.y>0?this._quadrants[1]:this._quadrants[2]},h.prototype._calcDispersion=function(t,e){const n=t.items,i=t[e],o=i.total/n.length;for(let t=0;t<n.length;t++){const s=n[t];i.dispersion+=Math.abs(s.avgOriginPoint[e]-o)}},h.prototype._sort=function(){for(let t=0;t<4;t++)this._sortQuadrant(this._quadrants[t])},h.prototype._sortQuadrant=function(t){if(t.sortType)return;const e=t.items;this._calcDispersion(t,"x"),this._calcDispersion(t,"y");let n="",i="";t.x.dispersion>t.y.dispersion?(n=t.sortType="x",i="y"):(n=t.sortType="y",i="x"),e.sort(((t,e)=>{const o=t.absOriginPoint,s=e.absOriginPoint;return o[n]===s[n]?o[i]-s[i]:o[n]-s[n]}))},h.prototype.getElementsRelative=function(t){return this.getElements(this._getCSYSPoint(t))},h.prototype.getElements=function(t){const{x:e,y:n}=t;if(!e||!n)return[];const i=this._getQuadrant(t);i.sortType||this._sortQuadrant(i);const o={x:Math.abs(e),y:Math.abs(n)},s=i.sortType,l="x"===s?"y":"x",r=[];for(let t=0;t<i.items.length;t++){const e=i.items[t];if(e.absOriginPoint[s]>o[s])break;e.absOriginPoint[l]<=o[l]&&r.push(e.element)}return r};function d(t){this._holding=!0,this._selection.show(),"disposable"===this._options.mode&&this.clearSelected();const{onHold:e,threshold:n}=this._options;this._intersectionStrategy.start(t),this._throttleHold||(this._throttleHold=function(t,e,n,i){let o,s=!1,l=0;function r(){o&&clearTimeout(o)}function c(...c){let a=this,h=Date.now()-l;function d(){l=Date.now(),n.apply(a,c)}s||(i&&!o&&d(),r(),void 0===i&&h>t?d():!0!==e&&(o=setTimeout(i?function(){o=void 0}:d,void 0===i?t-h:t)))}return"boolean"!=typeof e&&(i=n,n=e,e=void 0),c.cancel=function(){r(),s=!0},c}(n,(n=>{if(!this._holding)return;const i=this._intersectionStrategy.hold(n),{added:o,removed:s}=this._resolveSelectedEls(i);this._recentSelectedEls=i,e.call(null,{start:{...t.startPoint},active:{...t.activePoint},added:o,removed:s})})));const i=this._options.onStart;i&&i.call(null,{start:{...t.startPoint}})}function u(t){this._updateSelection(t.startPoint,t.activePoint),this._throttleHold&&this._throttleHold(t)}function p(t){this._holding=!1,this._updateSelection(t.startPoint,t.activePoint);const e=this._intersectionStrategy.end(t),{added:n,removed:i,selected:o}=this._resolveSelectedEls(e,!0);this._curSelectedEls=o.concat(),this._recentSelectedEls=[];const s=this._options.onEnd;s&&s.call(null,{start:{...t.startPoint},active:{...t.activePoint},added:n,removed:i,selected:o}),this._selection.hide()}function _(t,e){const n=t.contentX,i=t.contentY,o=e.contentX,s=e.contentY;this._selection.update(n,i,o-n,s-i)}function f(t,e){t=t.concat(),e=e.concat();const n=[];for(let i=0;i<t.length;i++)for(let o=0;o<e.length;o++)if(t[i]===e[o]){n.push(t[i]),t.splice(i,1),e.splice(o,1),i--;break}return{diff:[t,e],duplicate:n}}function g(t){let e=-1;for(;++e<t.length;)n(t[e],"pika9-selected")}function y(t){let e=-1;for(;++e<t.length;)i(t[e],"pika9-selected")}function m(t,e){const n=f(this._recentSelectedEls,t),i=f(n.diff[0],this._curSelectedEls),o=f(n.diff[1],this._curSelectedEls),s=i.duplicate,l=i.diff[0],r=o.duplicate,c=o.diff[0],a={added:[],removed:[]},h=this._options.mode;if("disposable"===h||"append"===h){if(a.added=c,a.removed=l,g(a.added),y(a.removed),e)if("disposable"===h)a.selected=this._recentSelectedEls;else{const e=f(this._curSelectedEls,t);a.selected=e.diff[0].concat(e.diff[1]).concat(e.duplicate)}return a}if("toggle"===h){if(a.added=c.concat(s),a.removed=l.concat(r),g(a.added),y(a.removed),e){const e=f(this._curSelectedEls,t);a.selected=e.diff[0].concat(e.diff[1])}return a}}function v(){y(this._curSelectedEls),this._curSelectedEls=[]}const b={_baseMergeOptions:null,_options:null,_intersectionStrategy:null,_selection:null,_holder:null,_throttleHold:null,_recentSelectedEls:[],_curSelectedEls:[],_enable:!1,_holding:!1};function E(){this._enable=!0,this._holder.enable()}function S(){this._enable=!1,this._holder.disable()}function P(){const t=this._enable,e=this._baseMergeOptions;this.unload(),this._baseMergeOptions=e,this._load(),t&&this.enable()}function H(){this._holder.unload(),this._selection.unmount(),this.clearSelected(),o(this,b)}const x={parent:null,children:null,threshold:200,onStart:null,onHold:null,onEnd:null,mode:"toggle",clearOnClick:!0};function w(t){if(!window||!document)throw new Error("make sure you running Pika9.js in bowser");o(this,b),this._baseMergeOptions=o({...x},t||{}),this._load()}!function(t){t.prototype._onHoldStart=d,t.prototype._onHoldMove=u,t.prototype._onHoldEnd=p,t.prototype._updateSelection=_,t.prototype._resolveSelectedEls=m,t.prototype.clearSelected=v}(w),function(t){t.prototype.enable=E,t.prototype.disable=S,t.prototype.reload=P,t.prototype.unload=H}(w),w.prototype._load=function(){const e={...this._baseMergeOptions},n=e.parent,i=e.children,o=function(e,n=document){const i=t(e)?e:e&&n.querySelector(e)||null;return 1===i.nodeType?i:null}(n);if(!o)throw new Error("invalid parent node");let s=null;if(s=function(e,n=document){return(t(e)?[e]:e&&Array.prototype.slice.call(n.querySelectorAll(e))||[null]).filter((t=>t&&1===t.nodeType))}(i),!s.length)throw new Error("invalid children nodes");e.parent=o,e.children=s,this._options=Object.freeze(e),this._intersectionStrategy=new h({elements:this._options.children}),this._selection=new c(this._options.parent),this._selection.mount(),this._holder=new r(o,{onClick:()=>{this._options.clearOnClick&&this.clearSelected()},onHoldStart:t=>{this._onHoldStart(t)},onHoldMove:t=>{this._onHoldMove(t)},onHoldEnd:t=>{this._onHoldEnd(t)}}),this._throttleHold=null,this._selectedElements=[],this._holding=!0},module.exports=w;
